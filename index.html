<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ارزیابی برقکار</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background: #f1f5f9; min-height: 100vh; margin: 0; }
        .container { max-width: 960px; margin: 0 auto; padding: 1.5rem; }
        h1 { font-size: 2.2rem; font-weight: 700; text-align: center; color: #1e40af; margin: 2rem 0 1.5rem; }
        .progress-bar { height: 6px; background: #cbd5e1; border-radius: 3px; margin: 1.5rem 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.6s ease; }
        .steps-container { position: relative; min-height: 600px; }
        .step { position: absolute; top: 0; left: 0; width: 100%; opacity: 0; visibility: hidden; transition: opacity 0.6s ease, transform 0.6s ease; transform: translateY(20px); }
        .step.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .card { background: white; border-radius: 1.2rem; padding: 2rem; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        h2 { font-size: 1.6rem; font-weight: 700; color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 0.8rem; margin-bottom: 1.8rem; }
        label { font-weight: 600; color: #475569; font-size: 1.1rem; margin-bottom: 0.6rem; display: block; }
        input[type="text"], textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #cbd5e1;
            border-radius: 1rem;
            background: #f8fafc;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e40af;
            text-align: center;
        }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 0.8rem; }
        .radio-item { 
            display: flex; align-items: center; gap: 0.8rem; 
            background: #eff6ff; padding: 0.8rem 1.5rem; 
            border-radius: 1rem; font-size: 1.05rem; 
            border: 2px solid #dbeafe; 
        }
        button { background: #3b82f6; color: white; padding: 1rem 3rem; border-radius: 1.5rem; font-weight: 600; font-size: 1.2rem; border: none; cursor: pointer; }
        .final-btn { background: #8b5cf6; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 1rem; }
        th { background: #dbeafe; padding: 1rem; text-align: center; font-weight: 600; font-size: 1.1rem; border-radius: 1rem; }
        td { background: #f8fafc; padding: 1rem; border-radius: 1rem; text-align: center; }
        .total-input { background: #dbeafe; font-weight: 700; color: #1e40af; font-size: 1.3rem; }
        .alert { background: #fee2e2; color: #991b1b; padding: 1.2rem; border-radius: 1rem; font-weight: 600; border-right: 5px solid #ef4444; text-align: center; }
        .btn-container { text-align: center; margin-top: 2.5rem; }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            .radio-group { flex-direction: column; align-items: center; }
            .radio-item { width: 100%; max-width: 350px; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>فرم ارزیابی برقکار</h1>
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>

        <div class="steps-container">
            <!-- بخش ۱ -->
            <div class="step card active" id="step-1">
                <h2>بخش ۱ | اطلاعات عمومی</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label>نام و نام خانوادگی برقکار</label><input type="text" id="electrician_name" required></div>
                    <div><label>کد عضویت / شماره تماس</label><input type="text" id="membership_code"></div>
                    <div class="md:col-span-2"><label>نشانی پروژه مورد بازدید</label><input type="text" id="project_address"></div>
                    <div><label>نوع پروژه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="project_type" value="مسکونی"><span>مسکونی</span></div>
                        <div class="radio-item"><input type="radio" name="project_type" value="تجاری"><span>تجاری</span></div>
                        <div class="radio-item"><input type="radio" name="project_type" value="اداری"><span>اداری</span></div>
                        <div class="radio-item"><input type="radio" name="project_type" value="صنعتی سبک"><span>صنعتی سبک</span></div>
                    </div></div>
                    <div><label>وضعیت پروژه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="project_status" value="در حال اجرا"><span>در حال اجرا</span></div>
                        <div class="radio-item"><input type="radio" name="project_status" value="تکمیل‌شده"><span>تکمیل‌شده</span></div>
                    </div></div>
                    <div class="md:col-span-2"><label>تاریخ و ساعت بازدید</label><input type="text" id="visit_datetime" class="total-input" readonly></div>
                </div>
                <div class="btn-container"><button onclick="nextStep(1)">بعدی</button></div>
            </div>

            <!-- بخش ۲ -->
            <div class="step card" id="step-2">
                <h2>بخش ۲ | مشخصات ارزیابان</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label>نام ارزیاب اول</label><input type="text" id="evaluator1_name" required></div>
                    <div><label>نام ارزیاب دوم</label><input type="text" id="evaluator2_name" required></div>
                </div>
                <div class="alert mt-6">⛔ ارزیابی باید حتماً توسط دو نفر انجام شود.</div>
                <div class="btn-container"><button onclick="nextStep(2)">بعدی</button></div>
            </div>

            <!-- بخش ۳ -->
            <div class="step card" id="step-3">
                <h2>بخش ۳ | ارزیابی فنی و اجرایی (۳۰ امتیاز)</h2>
                <table>
                    <thead><tr><th>ردیف</th><th>شاخص</th><th colspan="6">امتیاز (۰ تا ۵)</th></tr></thead>
                    <tbody>
                        <tr><td>۱</td><td>رعایت اصول سیم‌کشی</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech1" value="0">۰</div>
                            <div class="radio-item"><input type="radio" name="tech1" value="1">۱</div>
                            <div class="radio-item"><input type="radio" name="tech1" value="2">۲</div>
                            <div class="radio-item"><input type="radio" name="tech1" value="3">۳</div>
                            <div class="radio-item"><input type="radio" name="tech1" value="4">۴</div>
                            <div class="radio-item"><input type="radio" name="tech1" value="5">۵</div>
                        </td></tr>
                        <tr><td>۲</td><td>کیفیت تابلو برق</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech2" value="0">۰</div>
                            <div class="radio-item"><input type="radio" name="tech2" value="1">۱</div>
                            <div class="radio-item"><input type="radio" name="tech2" value="2">۲</div>
                            <div class="radio-item"><input type="radio" name="tech2" value="3">۳</div>
                            <div class="radio-item"><input type="radio" name="tech2" value="4">۴</div>
                            <div class="radio-item"><input type="radio" name="tech2" value="5">۵</div>
                        </td></tr>
                        <tr><td>۳</td><td>ایمنی اجرا (اتصالات، ارت، حفاظت)</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech3" value="0">۰</div>
                            <div class="radio-item"><input type="radio" name="tech3" value="1">۱</div>
                            <div class="radio-item"><input type="radio" name="tech3" value="2">۲</div>
                            <div class="radio-item"><input type="radio" name="tech3" value="3">۳</div>
                            <div class="radio-item"><input type="radio" name="tech3" value="4">۴</div>
                            <div class="radio-item"><input type="radio" name="tech3" value="5">۵</div>
                        </td></tr>
                        <tr><td>۴</td><td>نظم، تمیزی و زیبایی کار</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech4" value="0">۰</div>
                            <div class="radio-item"><input type="radio" name="tech4" value="1">۱</div>
                            <div class="radio-item"><input type="radio" name="tech4" value="2">۲</div>
                            <div class="radio-item"><input type="radio" name="tech4" value="3">۳</div>
                            <div class="radio-item"><input type="radio" name="tech4" value="4">۴</div>
                            <div class="radio-item"><input type="radio" name="tech4" value="5">۵</div>
                        </td></tr>
                        <tr><td>۵</td><td>رعایت حداقل‌های مبحث ۱۳</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech5" value="0">۰</div>
                            <div class="radio-item"><input type="radio" name="tech5" value="1">۱</div>
                            <div class="radio-item"><input type="radio" name="tech5" value="2">۲</div>
                            <div class="radio-item"><input type="radio" name="tech5" value="3">۳</div>
                            <div class="radio-item"><input type="radio" name="tech5" value="4">۴</div>
                            <div class="radio-item"><input type="radio" name="tech5" value="5">۵</div>
                        </td></tr>
                    </tbody>
                </table>
                <div class="mt-6"><label>جمع امتیاز این بخش (از ۳۰)</label><input type="text" id="section3_total" class="total-input" readonly></div>
                <div class="btn-container"><button onclick="nextStep(3)">بعدی</button></div>
            </div>

            <!-- بخش ۴ -->
            <div class="step card" id="step-4">
                <h2>بخش ۴ | رعایت نرخنامه و اصول صنفی (۲۰ امتیاز)</h2>
                <table>
                    <thead><tr><th>ردیف</th><th>مورد بررسی</th><th>وضعیت</th></tr></thead>
                    <tbody>
                        <tr><td>۱</td><td>قرارداد یا توافق مشخص دارد</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="rule1" value="5">بله</div>
                            <div class="radio-item"><input type="radio" name="rule1" value="0">خیر</div>
                        </td></tr>
                        <tr><td>۲</td><td>قیمت مطابق نرخنامه کمیته</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="rule2" value="5">بله</div>
                            <div class="radio-item"><input type="radio" name="rule2" value="0">خیر</div>
                        </td></tr>
                        <tr><td>۳</td><td>عدم قیمت‌شکنی</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="rule3" value="5">بله</div>
                            <div class="radio-item"><input type="radio" name="rule3" value="0">خیر</div>
                        </td></tr>
                        <tr><td>۴</td><td>شکایت مالی ثبت‌شده ندارد</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="rule4" value="5">بله</div>
                            <div class="radio-item"><input type="radio" name="rule4" value="0">خیر</div>
                        </td></tr>
                    </tbody>
                </table>
                <div class="mt-6"><label>امتیاز این بخش (۰ تا ۲۰)</label><input type="text" id="section4_total" class="total-input" readonly></div>
                <div class="btn-container"><button onclick="nextStep(4)">بعدی</button></div>
            </div>

            <!-- بخش ۵ -->
            <div class="step card" id="step-5">
                <h2>بخش ۵ | کیفیت کلی اجرا (۱۵ امتیاز)</h2>
                <div class="grid grid-cols-1 gap-6">
                    <div><label>کیفیت کلی اجرا</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="quality" value="0">ضعیف</div>
                        <div class="radio-item"><input type="radio" name="quality" value="5">متوسط</div>
                        <div class="radio-item"><input type="radio" name="quality" value="10">خوب</div>
                        <div class="radio-item"><input type="radio" name="quality" value="15">عالی</div>
                    </div></div>
                </div>
                <div class="mt-6"><label>امتیاز این بخش (۰ تا ۱۵)</label><input type="text" id="section5_total" class="total-input" readonly></div>
                <div class="btn-container"><button onclick="nextStep(5)">بعدی</button></div>
            </div>

            <!-- بخش ۶ -->
            <div class="step card" id="step-6">
                <h2>بخش ۶ | سابقه و تجربه کاری (۲۰ امتیاز)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label>سابقه کاری اعلام‌شده (سال)</label><input type="text" id="experience_years"></div>
                    <div><label>سطح تجربه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="exp_level" value="5">کمتر از ۵ سال</div>
                        <div class="radio-item"><input type="radio" name="exp_level" value="10">۵ تا ۱۰ سال</div>
                        <div class="radio-item"><input type="radio" name="exp_level" value="15">۱۰ تا ۲۰ سال</div>
                        <div class="radio-item"><input type="radio" name="exp_level" value="20">بیش از ۲۰ سال</div>
                    </div></div>
                </div>
                <div class="mt-6"><label>امتیاز این بخش (۰ تا ۲۰)</label><input type="text" id="section6_total" class="total-input" readonly></div>
                <div class="btn-container"><button onclick="nextStep(6)">بعدی</button></div>
            </div>

            <!-- بخش ۷ -->
            <div class="step card" id="step-7">
                <h2>بخش ۷ | اعتبار حرفه‌ای و همکاری صنفی (۱۵ امتیاز)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label>همکاری با کمیته</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="cooperation" value="0">ضعیف</div>
                        <div class="radio-item"><input type="radio" name="cooperation" value="3">متوسط</div>
                        <div class="radio-item"><input type="radio" name="cooperation" value="5">خوب</div>
                    </div></div>
                    <div><label>رفتار حرفه‌ای در کارگاه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="behavior" value="0">ضعیف</div>
                        <div class="radio-item"><input type="radio" name="behavior" value="3">متوسط</div>
                        <div class="radio-item"><input type="radio" name="behavior" value="5">خوب</div>
                    </div></div>
                    <div><label>سابقه شکایت</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="complaint" value="0">دارد</div>
                        <div class="radio-item"><input type="radio" name="complaint" value="5">ندارد</div>
                    </div></div>
                </div>
                <div class="mt-6"><label>امتیاز این بخش (۰ تا ۱۵)</label><input type="text" id="section7_total" class="total-input" readonly></div>
                <div class="btn-container"><button onclick="nextStep(7)">بعدی</button></div>
            </div>

            <!-- بخش ۸ -->
            <div class="step card" id="step-8">
                <h2>بخش ۸ | جمع‌بندی نهایی</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label>جمع کل امتیازات (از ۱۰۰)</label><input type="text" id="total_score" class="total-input" readonly></div>
                    <div><label>رتبه پیشنهادی</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="rank" value="A">A</div>
                        <div class="radio-item"><input type="radio" name="rank" value="B">B</div>
                        <div class="radio-item"><input type="radio" name="rank" value="C">C</div>
                    </div></div>
                </div>
                <div class="mt-6"><label>نظر تکمیلی ارزیابان</label><textarea rows="5" id="comments"></textarea></div>
                <div class="btn-container"><button class="final-btn" id="final-save-btn">تایید نهایی و دانلود PDF</button></div>
            </div>
        </div>

        <!-- تاریخچه -->
        <div class="card mt-10">
            <h2>تاریخچه ارزیابی‌ها</h2>
            <div id="history-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const totalSteps = 8;
        let currentStep = 1;
        let pdfCanvases = [];

        function updateDateTime() {
            const field = document.getElementById('visit_datetime');
            if (field) {
                const now = new Date();
                field.value = now.toLocaleString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        function calculateScores() {
            let s3 = 0;
            for (let i = 1; i <= 5; i++) {
                const checked = document.querySelector(`input[name="tech${i}"]:checked`);
                if (checked) s3 += parseInt(checked.value);
            }
            document.getElementById('section3_total').value = s3;

            let s4 = 0;
            for (let i = 1; i <= 4; i++) {
                const checked = document.querySelector(`input[name="rule${i}"]:checked`);
                if (checked) s4 += parseInt(checked.value);
            }
            document.getElementById('section4_total').value = s4;

            const quality = document.querySelector('input[name="quality"]:checked');
            document.getElementById('section5_total').value = quality ? parseInt(quality.value) : 0;

            const exp = document.querySelector('input[name="exp_level"]:checked');
            document.getElementById('section6_total').value = exp ? parseInt(exp.value) : 0;

            let s7 = 0;
            ['cooperation', 'behavior', 'complaint'].forEach(name => {
                const checked = document.querySelector(`input[name="${name}"]:checked`);
                if (checked) s7 += parseInt(checked.value);
            });
            document.getElementById('section7_total').value = s7;

            const total = s3 + s4 + (quality ? parseInt(quality.value) : 0) + (exp ? parseInt(exp.value) : 0) + s7;
            document.getElementById('total_score').value = total;
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            document.getElementById('progress').style.width = `${(step / totalSteps) * 100}%`;
        }

        async function nextStep(step) {
            calculateScores();

            const element = document.getElementById(`step-${step}`);
            const canvas = await html2canvas(element, { scale: 2.5, useCORS: true, backgroundColor: '#ffffff' });
            pdfCanvases[step - 1] = canvas;

            if (step < totalSteps) {
                currentStep = step + 1;
                showStep(currentStep);
            }
        }

        async function generateFullPDF() {
            calculateScores();

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;

            for (let i = 0; i < pdfCanvases.length; i++) {
                if (i > 0) pdf.addPage();
                const canvas = pdfCanvases[i];
                const imgWidth = pdfWidth - 2 * margin;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', margin, margin, imgWidth, imgHeight);
            }

            const name = document.getElementById('electrician_name').value.trim() || 'برقکار';
            pdf.save(`ارزیابی_${name}.pdf`);

            // ذخیره در localStorage
            const data = {
                electrician_name: name,
                total_score: document.getElementById('total_score').value,
                rank: document.querySelector('input[name="rank"]:checked')?.value || '—',
                timestamp: new Date().toLocaleString('fa-IR'),
                fullData: {}
            };
            document.querySelectorAll('input[type="text"], textarea').forEach(el => data.fullData[el.id] = el.value);
            document.querySelectorAll('input[type="radio"]:checked').forEach(el => data.fullData[el.name] = el.value);

            let history = JSON.parse(localStorage.getItem('evaluations') || '[]');
            history.unshift(data);
            localStorage.setItem('evaluations', JSON.stringify(history));
            loadHistory();

            alert('PDF دانلود شد و ارزیابی ذخیره گردید!');
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const list = document.getElementById('history-list');
            list.innerHTML = history.length === 0 ? '<p class="text-center text-gray-500 py-6">هنوز ارزیابی ثبت نشده است.</p>' : '';
            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg border-r-4 border-blue-600';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold">${item.electrician_name}</div>
                            <div class="text-sm text-gray-600">امتیاز: ${item.total_score} | رتبه: ${item.rank} | ${item.timestamp}</div>
                        </div>
                        <div class="flex gap-3">
                            <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="editEvaluation(${index})">ویرایش</button>
                            <button class="bg-red-600 text-white px-4 py-2 rounded" onclick="deleteEvaluation(${index})">حذف</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        window.editEvaluation = function(index) {
            const history = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const item = history[index].fullData;
            Object.keys(item).forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = item[key];
                const radio = document.querySelector(`input[name="${key}"][value="${item[key]}"]`);
                if (radio) radio.checked = true;
            });
            calculateScores();
            history.splice(index, 1);
            localStorage.setItem('evaluations', JSON.stringify(history));
            loadHistory();
            showStep(1);
        };

        window.deleteEvaluation = function(index) {
            if (confirm('حذف این ارزیابی؟')) {
                const history = JSON.parse(localStorage.getItem('evaluations') || '[]');
                history.splice(index, 1);
                localStorage.setItem('evaluations', JSON.stringify(history));
                loadHistory();
            }
        };

        document.getElementById('final-save-btn').addEventListener('click', generateFullPDF);

        showStep(1);
        document.addEventListener('change', calculateScores);
        loadHistory();
    </script>
</body>
</html>
