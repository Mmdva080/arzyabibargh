<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ارزیابی برقکار</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background: #f1f5f9; color: #334155; min-height: 100vh; margin: 0; }
        .container { max-width: 960px; margin: 0 auto; padding: 1rem; }
        .card { background: white; border-radius: 1rem; padding: 1.8rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { font-size: 2rem; font-weight: 600; text-align: center; color: #1e40af; margin: 2rem 0 1.5rem; }
        h2 { font-size: 1.4rem; font-weight: 600; color: #1e40af; border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        label { font-weight: 500; color: #475569; font-size: 1rem; margin-bottom: 0.5rem; display: block; }
        input[type="text"], textarea { width: 100%; padding: 0.8rem 1rem; border: 1.5px solid #cbd5e1; border-radius: 0.75rem; background: #f8fafc; font-size: 1rem; }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem; }
        .radio-item { display: flex; align-items: center; gap: 0.6rem; background: #eff6ff; padding: 0.7rem 1.2rem; border-radius: 1rem; font-size: 1rem; }
        button { background: #3b82f6; color: white; padding: 0.9rem 2rem; border-radius: 1rem; font-weight: 600; font-size: 1.1rem; margin: 0.5rem; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 0.8rem; }
        th { background: #dbeafe; padding: 0.9rem; text-align: center; font-weight: 600; font-size: 1rem; border-radius: 1rem; }
        td { background: #f8fafc; padding: 0.9rem; border-radius: 1rem; }
        .history-item { background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-right: 5px solid #3b82f6; cursor: pointer; margin-bottom: 1rem; }
        .total-input { background: #dbeafe; font-weight: 600; color: #1e40af; text-align: center; }
        .alert { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 1rem; font-weight: 600; border-right: 4px solid #ef4444; }
        @media (max-width: 768px) {
            .container { padding: 0.8rem; }
            .card { padding: 1.5rem; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.3rem; }
            button { padding: 0.8rem 1.8rem; font-size: 1rem; }
            .radio-item { padding: 0.6rem 1rem; font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div class="container" id="pdf-content">
        <h1>فرم ارزیابی برقکار</h1>

        <form id="evaluation-form" class="card">
            <!-- بخش ۱ -->
            <div>
                <h2>بخش ۱ | اطلاعات عمومی</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label>نام و نام خانوادگی برقکار</label><input type="text" id="electrician_name" required></div>
                    <div><label>کد عضویت / شماره تماس</label><input type="text" id="membership_code"></div>
                    <div class="md:col-span-2"><label>نشانی پروژه مورد بازدید</label><input type="text" id="project_address"></div>
                    <div><label>نوع پروژه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="project_type" value="مسکونی"><span>مسکونی</span></div>
                        <div class="radio-item"><input type="radio" name="project_type" value="تجاری"><span>تجاری</span></div>
                        <div class="radio-item"><input type="radio" name="project_type" value="اداری"><span>اداری</span></div>
                        <div class="radio-item"><input type="radio" name="project_type" value="صنعتی سبک"><span>صنعتی سبک</span></div>
                    </div></div>
                    <div><label>وضعیت پروژه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="project_status" value="در حال اجرا"><span>در حال اجرا</span></div>
                        <div class="radio-item"><input type="radio" name="project_status" value="تکمیل‌شده"><span>تکمیل‌شده</span></div>
                    </div></div>
                    <div class="md:col-span-2"><label>تاریخ و ساعت بازدید</label><input type="text" id="visit_datetime" class="total-input" readonly></div>
                </div>
            </div>

            <!-- بخش ۲ -->
            <div class="mt-10">
                <h2>بخش ۲ | مشخصات ارزیابان</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label>نام ارزیاب اول</label><input type="text" id="evaluator1_name" required></div>
                    <div><label>نام ارزیاب دوم</label><input type="text" id="evaluator2_name" required></div>
                </div>
                <div class="alert mt-5">⛔ ارزیابی باید حتماً توسط دو نفر انجام شود.</div>
            </div>

            <!-- بخش ۳ -->
            <div class="mt-10">
                <h2>بخش ۳ | ارزیابی فنی و اجرایی (۳۰ امتیاز)</h2>
                <table>
                    <thead><tr><th>ردیف</th><th>شاخص</th><th colspan="6">امتیاز (۰ تا ۵)</th></tr></thead>
                    <tbody>
                        <tr><td>۱</td><td>رعایت اصول سیم‌کشی</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech1" value="0">۰</div><div class="radio-item"><input type="radio" name="tech1" value="1">۱</div><div class="radio-item"><input type="radio" name="tech1" value="2">۲</div><div class="radio-item"><input type="radio" name="tech1" value="3">۳</div><div class="radio-item"><input type="radio" name="tech1" value="4">۴</div><div class="radio-item"><input type="radio" name="tech1" value="5">۵</div>
                        </td></tr>
                        <tr><td>۲</td><td>کیفیت تابلو برق</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech2" value="0">۰</div><div class="radio-item"><input type="radio" name="tech2" value="1">۱</div><div class="radio-item"><input type="radio" name="tech2" value="2">۲</div><div class="radio-item"><input type="radio" name="tech2" value="3">۳</div><div class="radio-item"><input type="radio" name="tech2" value="4">۴</div><div class="radio-item"><input type="radio" name="tech2" value="5">۵</div>
                        </td></tr>
                        <tr><td>۳</td><td>ایمنی اجرا (اتصالات، ارت، حفاظت)</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech3" value="0">۰</div><div class="radio-item"><input type="radio" name="tech3" value="1">۱</div><div class="radio-item"><input type="radio" name="tech3" value="2">۲</div><div class="radio-item"><input type="radio" name="tech3" value="3">۳</div><div class="radio-item"><input type="radio" name="tech3" value="4">۴</div><div class="radio-item"><input type="radio" name="tech3" value="5">۵</div>
                        </td></tr>
                        <tr><td>۴</td><td>نظم، تمیزی و زیبایی کار</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech4" value="0">۰</div><div class="radio-item"><input type="radio" name="tech4" value="1">۱</div><div class="radio-item"><input type="radio" name="tech4" value="2">۲</div><div class="radio-item"><input type="radio" name="tech4" value="3">۳</div><div class="radio-item"><input type="radio" name="tech4" value="4">۴</div><div class="radio-item"><input type="radio" name="tech4" value="5">۵</div>
                        </td></tr>
                        <tr><td>۵</td><td>رعایت حداقل‌های مبحث ۱۳</td><td class="radio-group">
                            <div class="radio-item"><input type="radio" name="tech5" value="0">۰</div><div class="radio-item"><input type="radio" name="tech5" value="1">۱</div><div class="radio-item"><input type="radio" name="tech5" value="2">۲</div><div class="radio-item"><input type="radio" name="tech5" value="3">۳</div><div class="radio-item"><input type="radio" name="tech5" value="4">۴</div><div class="radio-item"><input type="radio" name="tech5" value="5">۵</div>
                        </td></tr>
                    </tbody>
                </table>
                <div class="mt-5"><label>جمع امتیاز این بخش (از ۳۰)</label><input type="text" id="section3_total" class="total-input" readonly></div>
            </div>

            <!-- بخش ۴ -->
            <div class="mt-10">
                <h2>بخش ۴ | رعایت نرخنامه و اصول صنفی (۲۰ امتیاز)</h2>
                <table>
                    <thead><tr><th>ردیف</th><th>مورد بررسی</th><th>وضعیت</th></tr></thead>
                    <tbody>
                        <tr><td>۱</td><td>قرارداد یا توافق مشخص دارد</td><td class="radio-group"><div class="radio-item"><input type="radio" name="rule1" value="5">بله</div><div class="radio-item"><input type="radio" name="rule1" value="0">خیر</div></td></tr>
                        <tr><td>۲</td><td>قیمت مطابق نرخنامه کمیته</td><td class="radio-group"><div class="radio-item"><input type="radio" name="rule2" value="5">بله</div><div class="radio-item"><input type="radio" name="rule2" value="0">خیر</div></td></tr>
                        <tr><td>۳</td><td>عدم قیمت‌شکنی</td><td class="radio-group"><div class="radio-item"><input type="radio" name="rule3" value="5">بله</div><div class="radio-item"><input type="radio" name="rule3" value="0">خیر</div></td></tr>
                        <tr><td>۴</td><td>شکایت مالی ثبت‌شده ندارد</td><td class="radio-group"><div class="radio-item"><input type="radio" name="rule4" value="5">بله</div><div class="radio-item"><input type="radio" name="rule4" value="0">خیر</div></td></tr>
                    </tbody>
                </table>
                <div class="mt-5"><label>امتیاز این بخش (۰ تا ۲۰)</label><input type="text" id="section4_total" class="total-input" readonly></div>
            </div>

            <!-- بخش ۵ -->
            <div class="mt-10">
                <h2>بخش ۵ | کیفیت کلی اجرا (۱۵ امتیاز)</h2>
                <div class="grid grid-cols-1 gap-5">
                    <div><label>کیفیت کلی اجرا</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="quality" value="0">ضعیف</div>
                        <div class="radio-item"><input type="radio" name="quality" value="5">متوسط</div>
                        <div class="radio-item"><input type="radio" name="quality" value="10">خوب</div>
                        <div class="radio-item"><input type="radio" name="quality" value="15">عالی</div>
                    </div></div>
                </div>
                <div class="mt-5"><label>امتیاز این بخش (۰ تا ۱۵)</label><input type="text" id="section5_total" class="total-input" readonly></div>
            </div>

            <!-- بخش ۶ -->
            <div class="mt-10">
                <h2>بخش ۶ | سابقه و تجربه کاری (۲۰ امتیاز)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label>سابقه کاری اعلام‌شده (سال)</label><input type="text" id="experience_years"></div>
                    <div><label>سطح تجربه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="exp_level" value="5">کمتر از ۵ سال</div>
                        <div class="radio-item"><input type="radio" name="exp_level" value="10">۵ تا ۱۰ سال</div>
                        <div class="radio-item"><input type="radio" name="exp_level" value="15">۱۰ تا ۲۰ سال</div>
                        <div class="radio-item"><input type="radio" name="exp_level" value="20">بیش از ۲۰ سال</div>
                    </div></div>
                </div>
                <div class="mt-5"><label>امتیاز این بخش (۰ تا ۲۰)</label><input type="text" id="section6_total" class="total-input" readonly></div>
            </div>

            <!-- بخش ۷ -->
            <div class="mt-10">
                <h2>بخش ۷ | اعتبار حرفه‌ای و همکاری صنفی (۱۵ امتیاز)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div><label>همکاری با کمیته</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="cooperation" value="0">ضعیف</div>
                        <div class="radio-item"><input type="radio" name="cooperation" value="3">متوسط</div>
                        <div class="radio-item"><input type="radio" name="cooperation" value="5">خوب</div>
                    </div></div>
                    <div><label>رفتار حرفه‌ای در کارگاه</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="behavior" value="0">ضعیف</div>
                        <div class="radio-item"><input type="radio" name="behavior" value="3">متوسط</div>
                        <div class="radio-item"><input type="radio" name="behavior" value="5">خوب</div>
                    </div></div>
                    <div><label>سابقه شکایت</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="complaint" value="0">دارد</div>
                        <div class="radio-item"><input type="radio" name="complaint" value="5">ندارد</div>
                    </div></div>
                </div>
                <div class="mt-5"><label>امتیاز این بخش (۰ تا ۱۵)</label><input type="text" id="section7_total" class="total-input" readonly></div>
            </div>

            <!-- بخش ۸ -->
            <div class="mt-10">
                <h2>بخش ۸ | جمع‌بندی نهایی</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label>جمع کل امتیازات (از ۱۰۰)</label><input type="text" id="total_score" class="total-input" readonly></div>
                    <div><label>رتبه پیشنهادی</label><div class="radio-group">
                        <div class="radio-item"><input type="radio" name="rank" value="A">A</div>
                        <div class="radio-item"><input type="radio" name="rank" value="B">B</div>
                        <div class="radio-item"><input type="radio" name="rank" value="C">C</div>
                    </div></div>
                </div>
                <div class="mt-5"><label>نظر تکمیلی ارزیابان</label><textarea rows="4" id="comments"></textarea></div>
            </div>

            <div class="text-center mt-12 space-x-6">
                <button type="button" id="save-btn">ذخیره ارزیابی</button>
                <button type="button" id="pdf-btn">دانلود PDF</button>
                <button type="button" id="clear-all" class="bg-red-600">پاک کردن همه تاریخچه</button>
            </div>
        </form>

        <div class="card">
            <h2>تاریخچه ارزیابی‌ها</h2>
            <div id="history-list" class="space-y-5"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('evaluation-form');
        const historyList = document.getElementById('history-list');

        // بروزرسانی تاریخ و ساعت
        function updateDateTime() {
            const now = new Date();
            document.getElementById('visit_datetime').value = now.toLocaleString('fa-IR');
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // محاسبه امتیازات
        function calculateScores() {
            let s3 = 0;
            for (let i = 1; i <= 5; i++) {
                const val = document.querySelector(`input[name="tech${i}"]:checked`);
                s3 += val ? parseInt(val.value) : 0;
            }
            document.getElementById('section3_total').value = s3;

            let s4 = 0;
            for (let i = 1; i <= 4; i++) {
                const val = document.querySelector(`input[name="rule${i}"]:checked`);
                s4 += val ? parseInt(val.value) : 0;
            }
            document.getElementById('section4_total').value = s4;

            const quality = document.querySelector('input[name="quality"]:checked');
            document.getElementById('section5_total').value = quality ? parseInt(quality.value) : 0;

            const exp = document.querySelector('input[name="exp_level"]:checked');
            document.getElementById('section6_total').value = exp ? parseInt(exp.value) : 0;

            let s7 = 0;
            ['cooperation', 'behavior', 'complaint'].forEach(name => {
                const val = document.querySelector(`input[name="${name}"]:checked`);
                s7 += val ? parseInt(val.value) : 0;
            });
            document.getElementById('section7_total').value = s7;

            const total = s3 + s4 + (quality ? parseInt(quality.value) : 0) + (exp ? parseInt(exp.value) : 0) + s7;
            document.getElementById('total_score').value = total;
        }

        document.querySelectorAll('input[type="radio"]').forEach(el => el.addEventListener('change', calculateScores));

        // ذخیره در localStorage
        function saveEvaluation() {
            calculateScores();
            const data = {
                electrician_name: document.getElementById('electrician_name').value.trim() || 'نامشخص',
                total_score: document.getElementById('total_score').value,
                rank: document.querySelector('input[name="rank"]:checked')?.value || '—',
                timestamp: new Date().toLocaleString('fa-IR'),
                fullData: {}
            };

            // ذخیره تمام داده‌های فرم
            const formData = new FormData(form);
            formData.forEach((value, key) => data.fullData[key] = value);
            document.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked').forEach(el => {
                data.fullData[el.name] = el.value;
            });
            data.fullData.comments = document.getElementById('comments').value;

            let history = JSON.parse(localStorage.getItem('evaluations') || '[]');
            history.unshift(data);
            localStorage.setItem('evaluations', JSON.stringify(history));

            loadHistory();
            form.reset();
            updateDateTime();
            calculateScores();
            alert('ارزیابی ذخیره شد');
        }

        // بارگذاری تاریخچه
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('evaluations') || '[]');
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 py-6">هنوز ارزیابی ثبت نشده است.</p>';
                return;
            }
            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                        <div>
                            <div class="font-semibold text-lg">${item.electrician_name}</div>
                            <div class="text-gray-600 text-sm mt-1">امتیاز: ${item.total_score} | رتبه: ${item.rank} | ${item.timestamp}</div>
                        </div>
                        <div class="flex gap-3">
                            <button class="bg-blue-600 text-white px-6 py-2 rounded-lg" onclick="editEvaluation(${index})">ویرایش</button>
                            <button class="bg-red-600 text-white px-6 py-2 rounded-lg" onclick="deleteEvaluation(${index})">حذف</button>
                        </div>
                    </div>
                `;
                historyList.appendChild(div);
            });
        }

        // ویرایش
        window.editEvaluation = function(index) {
            const history = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const data = history[index].fullData;

            document.getElementById('electrician_name').value = data.electrician_name || '';
            document.getElementById('membership_code').value = data.membership_code || '';
            document.getElementById('project_address').value = data.project_address || '';
            document.getElementById('evaluator1_name').value = data.evaluator1_name || '';
            document.getElementById('evaluator2_name').value = data.evaluator2_name || '';
            document.getElementById('experience_years').value = data.experience_years || '';
            document.getElementById('comments').value = data.comments || '';

            // رادیو باتن‌ها
            ['project_type', 'project_status', 'quality', 'exp_level', 'cooperation', 'behavior', 'complaint', 'rank'].forEach(name => {
                if (data[name]) {
                    document.querySelector(`input[name="${name}"][value="${data[name]}"]`)?.checked = true;
                }
            });
            for (let i = 1; i <= 5; i++) {
                if (data[`tech${i}`]) document.querySelector(`input[name="tech${i}"][value="${data[`tech${i}`]}"]`)?.checked = true;
            }
            for (let i = 1; i <= 4; i++) {
                if (data[`rule${i}`]) document.querySelector(`input[name="rule${i}"][value="${data[`rule${i}`]}"]`)?.checked = true;
            }

            calculateScores();
            history.splice(index, 1);
            localStorage.setItem('evaluations', JSON.stringify(history));
            loadHistory();
            window.scrollTo(0, 0);
            alert('فرم برای ویرایش پر شد. تغییرات را اعمال کنید و دوباره ذخیره بزنید.');
        };

        // حذف
        window.deleteEvaluation = function(index) {
            if (confirm('حذف این ارزیابی؟')) {
                const history = JSON.parse(localStorage.getItem('evaluations') || '[]');
                history.splice(index, 1);
                localStorage.setItem('evaluations', JSON.stringify(history));
                loadHistory();
            }
        };

        // پاک کردن همه
        document.getElementById('clear-all').addEventListener('click', () => {
            if (confirm('همه ارزیابی‌ها پاک شود؟')) {
                localStorage.removeItem('evaluations');
                loadHistory();
            }
        });

        document.getElementById('save-btn').addEventListener('click', saveEvaluation);

        // دانلود PDF
        document.getElementById('pdf-btn').addEventListener('click', async () => {
            window.scrollTo(0, 0);
            const element = document.getElementById('pdf-content');
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            let imgHeight = canvas.height * width / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, width, imgHeight);
            heightLeft -= pdf.internal.pageSize.getHeight();

            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, width, imgHeight);
                heightLeft -= pdf.internal.pageSize.getHeight();
            }

            pdf.save('ارزیابی_برقکار.pdf');
        });

        loadHistory();
    </script>
</body>
</html>
