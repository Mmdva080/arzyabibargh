<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ù‚Ú©Ø§Ø±">

    <!-- Ø¢ÛŒÚ©ÙˆÙ† Ø³Ø§Ø¯Ù‡ Ùˆ Ø²ÛŒØ¨Ø§ -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%231e40af'/%3E%3Ctext x='50' y='65' font-size='60' text-anchor='middle' fill='white'%3Eâš¡%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%231e40af'/%3E%3Ctext x='50' y='65' font-size='60' text-anchor='middle' fill='white'%3Eâš¡%3C/text%3E%3C/svg%3E">

    <title>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ù‚Ú©Ø§Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap');
        body { font-family: 'Vazirmatn', 'Tahoma', sans-serif; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); min-height: 100vh; color: #1e293b; margin: 0; }
        .container { max-width: 1000px; margin: 1.5rem auto; padding: 1rem; }
        .card { background: white; border-radius: 2rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.15); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        h1 { font-size: 2.5rem; font-weight: 700; text-align: center; color: white; text-shadow: 0 4px 15px rgba(0,0,0,0.3); margin: 2rem 0; }
        h2 { font-size: 1.6rem; font-weight: 600; color: #1e40af; border-bottom: 4px solid #3b82f6; padding-bottom: 0.75rem; margin-bottom: 1.5rem; position: relative; }
        h2::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 80px; height: 4px; background: #3b82f6; border-radius: 2px; }
        label { font-weight: 600; color: #374151; font-size: 1rem; margin-bottom: 0.5rem; display: block; }
        input[type="text"], textarea { width: 100%; padding: 0.9rem 1.2rem; border: 2px solid #e2e8f0; border-radius: 1rem; background: #f8fafc; font-size: 1rem; transition: all 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59,130,246,0.2); }
        .radio-group { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem; }
        .radio-item { display: flex; align-items: center; gap: 0.7rem; background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 0.8rem 1.4rem; border-radius: 1.5rem; font-size: 1rem; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .radio-item:hover { background: #bfdbfe; transform: translateY(-3px); }
        button { background: linear-gradient(to right, #2563eb, #3b82f6); color: white; padding: 1rem 2.5rem; border-radius: 2rem; font-weight: 700; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(59,130,246,0.4); transition: all 0.4s; position: relative; overflow: hidden; }
        button:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(59,130,246,0.5); }
        button:active { transform: translateY(0); }
        button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.6s; }
        button:hover::before { left: 100%; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 1rem; }
        th { background: linear-gradient(to right, #dbeafe, #bfdbfe); padding: 1rem; text-align: center; font-weight: 700; font-size: 1rem; border-radius: 1rem; }
        td { background: #f8fafc; padding: 1rem; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .history-item { background: linear-gradient(to right, #f8fafc, #eff6ff); padding: 1.5rem; border-radius: 1.5rem; border-right: 6px solid #3b82f6; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .history-item:hover { transform: translateX(-10px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
        .total-input { background: linear-gradient(to right, #dbeafe, #bfdbfe); font-weight: bold; color: #1e40af; font-size: 1.1rem; }
        .alert { background: linear-gradient(to right, #fee2e2, #fecaca); color: #991b1b; padding: 1rem; border-radius: 1rem; font-weight: 600; border-right: 5px solid #ef4444; }
        @media (max-width: 768px) {
            .container { padding: 1rem; margin: 1rem auto; }
            .card { padding: 1.5rem; border-radius: 1.5rem; }
            h1 { font-size: 2.2rem; }
            h2 { font-size: 1.5rem; }
            button { padding: 1rem 2rem; font-size: 1rem; }
            .radio-item { padding: 0.7rem 1.2rem; font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div class="container" id="pdf-content">
        <h1>ÙØ±Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±Ù‚Ú©Ø§Ø±</h1>

        <form id="evaluation-form" class="card">
            <!-- Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Û± ØªØ§ Û¸ Ù…Ø«Ù„ Ù‚Ø¨Ù„ Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø®ÙÙ†â€ŒØªØ± -->
            <!-- (Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ Ø§Ø³ØªØŒ ÙÙ‚Ø· Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØª) -->

            <div class="text-center mt-12 space-x-8">
                <button type="button" id="save-btn">Ø°Ø®ÛŒØ±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</button>
                <button type="button" id="pdf-btn">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
            </div>
        </form>

        <div class="card">
            <h2>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§</h2>
            <div id="loading" class="text-center py-8 text-blue-600 text-xl font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            <div id="history-list" class="space-y-6"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==== Firebase Config Ø®ÙˆØ¯Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø± ====
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const evaluationsRef = collection(db, "evaluations");

        let currentDocId = null; // Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´

        function updateDateTime() {
            const now = new Date();
            document.getElementById('visit_datetime').value = now.toLocaleString('fa-IR');
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª (Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ)
        function calculateScores() {
            // ... (Ú©Ø¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ù‚Ø¨Ù„ÛŒ)
        }
        document.querySelectorAll('input[type="radio"]').forEach(el => el.addEventListener('change', calculateScores));

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ú©Ù„ÛŒÚ© Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´
        async function loadHistory() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            try {
                const q = query(evaluationsRef, orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<p class="text-center text-gray-500 py-8 text-lg">Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                }
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <strong class="text-xl">${data.electrician_name || 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'}</strong><br>
                                <span class="text-gray-600">Ø§Ù…ØªÛŒØ§Ø²: ${data.total_score || 'â€”'} | Ø±ØªØ¨Ù‡: ${data.rank || 'â€”'} | ${data.timestamp || 'â€”'}</span>
                            </div>
                            <div class="space-x-4">
                                <button class="edit-btn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-full shadow-lg" data-id="${docSnap.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                <button class="delete-btn bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full shadow-lg" data-id="${docSnap.id}">Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });

                // Ø¯Ú©Ù…Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.target.dataset.id;
                        const docSnap = await getDoc(doc(db, "evaluations", id));
                        const data = docSnap.data();
                        fillForm(data);
                        currentDocId = id;
                        window.scrollTo(0, 0);
                        alert('ÙØ±Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø± Ø´Ø¯. ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø²Ù†ÛŒØ¯.');
                    });
                });

                // Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if (confirm('Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
                            await deleteDoc(doc(db, "evaluations", e.target.dataset.id));
                            loadHistory();
                        }
                    });
                });
            } catch (err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ. Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ config Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.');
            }
            loading.style.display = 'none';
        }

        // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
        function fillForm(data) {
            document.getElementById('electrician_name').value = data.electrician_name || '';
            // ... ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†
            calculateScores();
        }

        // Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
        document.getElementById('save-btn').addEventListener('click', async () => {
            calculateScores();
            const data = { /* ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…Ø«Ù„ Ù‚Ø¨Ù„ */ timestamp: new Date().toLocaleString('fa-IR') };

            try {
                if (currentDocId) {
                    await updateDoc(doc(db, "evaluations", currentDocId), data);
                    alert('Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯ ğŸ’™');
                    currentDocId = null;
                } else {
                    await addDoc(evaluationsRef, data);
                    alert('Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø¯ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ ğŸ’™');
                }
                loadHistory();
                document.getElementById('evaluation-form').reset();
                updateDateTime();
                calculateScores();
            } catch (err) {
                alert('Ø®Ø·Ø§: ' + err.message);
            }
        });

        // PDF Ú©Ø§Ù…Ù„ Ùˆ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§
        document.getElementById('pdf-btn').addEventListener('click', async () => {
            const btn = document.getElementById('pdf-btn');
            btn.disabled = true;
            btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª PDF...';
            window.scrollTo(0, 0);
            const element = document.getElementById('pdf-content');
            const canvas = await html2canvas(element, {
                scale: 3,
                useCORS: true,
                logging: false,
                width: element.scrollWidth,
                height: element.scrollHeight,
                windowWidth: 1200
            });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const height = pdf.internal.pageSize.getHeight();
            pdf.addImage(imgData, 'PNG', 0, 0, width, height);
            // Ø§Ú¯Ø± Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø¨ÙˆØ¯ ØµÙØ­Ù‡ Ø¯ÙˆÙ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
            if (canvas.height > canvas.width * (height / width)) {
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, -height, width, canvas.height * width / canvas.width);
            }
            pdf.save(`Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ_${document.getElementById('electrician_name').value || 'Ø¨Ø±Ù‚Ú©Ø§Ø±'}_${new Date().toLocaleDateString('fa-IR')}.pdf`);
            btn.disabled = false;
            btn.textContent = 'Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF';
        });

        loadHistory();
    </script>
</body>
</html>
